'use strict';

var set = require('../set');

var deepFind = require('../_helpers/deepfind');

var apply = require('../_helpers/apply');

// creates event handler for target object which will be fired when a source is changed
module.exports = createCalcHandler;
function createCalcHandler(_ref) {
    var object = _ref.object,
        eventOptions = _ref.eventOptions,
        allSources = _ref.allSources,
        target = _ref.target,
        def = _ref.def,
        handler = _ref.handler;

    return function calcHandler() {
        var changeEvent = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};

        var values = [];
        var _changeEvent$protecto = changeEvent.protector,
            protector = _changeEvent$protecto === undefined ? {} : _changeEvent$protecto;

        var protectKey = target + def.id;

        var _keys,
            _l,
            _i,
            _source,
            _key,
            _result = {};

        _result.protector = protector

        for (_source = eventOptions, _keys = Object.keys(_source), _l = _keys.length, _i = 0; _i < _l; _i++) {
            _key = _keys[_i];
            _result[_key] = _source[_key];
        }

        for (_source = changeEvent, _keys = Object.keys(_source), _l = _keys.length, _i = 0; _i < _l; _i++) {
            _key = _keys[_i];
            _result[_key] = _source[_key];
        }

        var setEventOptions = _result;

        if (protectKey in protector) {
            return;
        }

        protector[protectKey] = true;

        for (var _target = allSources, _index = 0, _ref2, _l2 = _target.length; _ref2 = _target[_index], _index < _l2; _index++) {
            var sourceObject = _ref2.sourceObject,
                sourceKey = _ref2.sourceKey,
                isDelegated = _ref2.isDelegated;

            var value = isDelegated ? deepFind(sourceObject, sourceKey) : sourceObject[sourceKey];
            values.push(value);
        }

        var targetValue = apply(handler, object, values);
        set(object, target, targetValue, setEventOptions);
    };
}
//# sourceMappingURL=_createcalchandler.js.map